name: Generar informe Word

on:
  workflow_dispatch:
    inputs:
      lat:
        description: "Coordenada Y (latitud o Norte)"
        required: true
        type: string
      lon:
        description: "Coordenada X (longitud o Este)"
        required: true
        type: string
      input_crs:
        description: "CRS de entrada"
        required: true
        type: choice
        options:
          - "5367"
          - "4326"
      template:
        description: "Ruta a la plantilla DOCX"
        required: true
        type: string
        default: "templates/DA-UHSAN-XXXX-2025.Ins_XXXX-A.docx"
      output_name:
        description: "Nombre base del archivo de salida"
        required: false
        type: string
        default: "informe"

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Cache DEM
        id: cache-dem
        uses: actions/cache@v4
        with:
          path: data/dem/MED.CR.tif
          key: dem-data-dem-v1

      - name: Cache GIS zips
        id: cache-gis-zips
        uses: actions/cache@v4
        with:
          path: data/zips
          key: gis-zips-v1

      - name: Download DEM
        if: steps.cache-dem.outputs.cache-hit != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          mkdir -p data/dem
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          RELEASE_JSON=$(curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/data-dem-v1")
          ASSET_URL=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name=="MED.CR.tif") | .url')
          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
            echo "DEM asset not found in release data-dem-v1"
            echo "$RELEASE_JSON" | jq '.assets[].name'
            exit 1
          fi
          curl -L --fail \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$ASSET_URL" \
            -o data/dem/MED.CR.tif

      - name: Download GIS zips
        if: steps.cache-gis-zips.outputs.cache-hit != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -eux
          mkdir -p data/zips
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          RELEASES_JSON=$(curl -sSL \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases")

          HOJAS_ASSET_URL=$(echo "$RELEASES_JSON" | jq -r '.[] | select(.tag_name=="Hojas") | .assets[] | select(.name=="Hojas.zip") | .url' | head -n 1)
          CUENCAS_ASSET_URL=$(echo "$RELEASES_JSON" | jq -r '.[] | select(.tag_name=="Cuenca") | .assets[] | select(.name=="Cuencas.zip") | .url' | head -n 1)

          if [ -z "$HOJAS_ASSET_URL" ] || [ "$HOJAS_ASSET_URL" = "null" ]; then
            echo "Hojas.zip asset not found in release tagged Hojas"
            echo "Available release tags:"
            echo "$RELEASES_JSON" | jq -r '.[].tag_name'
            echo "Assets for release tag Hojas:"
            echo "$RELEASES_JSON" | jq -r '.[] | select(.tag_name=="Hojas") | .assets[].name'
            exit 1
          fi
          if [ -z "$CUENCAS_ASSET_URL" ] || [ "$CUENCAS_ASSET_URL" = "null" ]; then
            echo "Cuencas.zip asset not found in release tagged Cuenca"
            echo "Available release tags:"
            echo "$RELEASES_JSON" | jq -r '.[].tag_name'
            echo "Assets for release tag Cuenca:"
            echo "$RELEASES_JSON" | jq -r '.[] | select(.tag_name=="Cuenca") | .assets[].name'
            exit 1
          fi

          curl -L --fail \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$HOJAS_ASSET_URL" \
            -o data/zips/Hojas.zip

          curl -L --fail \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/octet-stream" \
            "$CUENCAS_ASSET_URL" \
            -o data/zips/Cuencas.zip

      - name: Generate report
        run: |
          set -eux
          export PYTHONPATH="${GITHUB_WORKSPACE}"
          python tools/generate_report.py \
            --x "${{ inputs.lon }}" \
            --y "${{ inputs.lat }}" \
            --crs "${{ inputs.input_crs }}" \
            --template "${{ inputs.template }}" \
            --out "output/informe_${{ github.run_id }}.docx"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: informe-word
          path: output/*.docx
          retention-days: 14
